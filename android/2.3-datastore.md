---
layout: article
title:  全新的可持续化数据方式：DataStore
permalink: /android/datastore
key:    2.3-datastore
author: ZeroGo
date:   2021-01-12 15:41:02 +0800
aside:
  toc: true
sidebar:
  nav: android-cn
---
自从Android诞生以来，持久化数据存储就有好多种手段，其中Preference被常常提起。一般来说，Preference是用于存储App的用户设置，并且Android还有PreferenceActivity、PreferenceFragment帮忙构建一个比较美观的设置页面。但是由于苹果的UI设计方案过于深入人心，许多软件为了在Android上模仿苹果的设计一般都不使用原生和之后推出的Material Design设计语言。

不过这一节并不是来说如何设计设置页面，而是来说一下它的后台。原版的Preference早就已经停用，现在的Preference、PreferenceFragmentCompat都是使用的支持库的东西（现在已经转移到了``androidx.preference``），而且已经停止了更新（版本号为1.1.1，最近更新时间为2020年4月15日）说明Google自己都认为这个API过于古老了。而且Google已经不再推荐使用PreferenceActivity，建议改用PreferenceFragmentCompat，在原本的Activity中使用替换布局的方式替换。而且一堆带有Compat的类，搞的这个API过于臃肿。既然Google已经决定弃用，那么是不是应该出一个新的？

于是，Jetpack DataStore就出现了。本节的剩余部分就是来介绍这个全新的API。

**注：**本文书写是所用的版本为``1.0.0-alpha06``，即DataStore现在处在Alpha阶段，*非常不稳定*，API会随时出现重大改动，慎重更新！本节也会稍微写一下可能会影响到改动你自己的程序代码的改动介绍。

# 写在前面
由于DataStore是一个全新的API，现在能获取到的信息很少，中文的资料就更少了。在我写这一部分的时候，中文相关文章不超过3篇，而且用的时候你会发现和Preference差的太远了，直接将Preference替换成DataStore是跑不出来的，因此这里给一些**真正能够让你跑通**的资料，好好研究一下。

- **官方的Codelab**：永远的神，任何你不懂的东西都要去这里看看，尤其是在刚刚出现新的API的时候，官方教你写的代码大多数都是可以跑的，否则就不能作为教程出现。[链接](https://developer.android.com/codelabs/android-preferences-datastore)在这里，请自取，需要科学上网。
- **Kotlin Flow**：原本的DataStore（``1.0.0-alpha06``）之前的DataStore实现都是使用的Kotlin Flow和协程（Coroutine），这里需要你对这俩有一定认识。这部分资料还是比较多的，本文会涉及到一些但是不会说的非常详细（因为我自己还在研究这个Flow）
- **RxJava**：如果你不会使用Flow也没关系，在``1.0.0-alpha06``的时候加入了两个全新的库：``androidx.datastore:datastore-rxjava2:1.0.0-alpha06``和``androidx.datastore:datastore-rxjava3:1.0.0-alpha06``，在使用这两个库的时候需要你对RxJava较熟悉。本文主要写有关Flow的，不会涉及到RxJava的内容，需要你自己来尝试尝试。

# 什么是DataStore？
DataStore是一种全新的持久化数据存储API，原本是基于Kotlin协程和Kotlin Flow开发的，用到了许多Kotlin的语言特性。DataStore分为Preference DataStore和Protobuf DataStore，这里主要介绍前者，后者我还需要自己慢慢探索。简单来说前者比较容易存储一些基础类型，但是比较复杂的存储就只能使用后者，后者存储较多较复杂数据的时候性能会高一些。值得一提的是，Protobuf也是Google搞出来的东西。

# DataStore到底有啥优势？
用一个表格来说明问题吧：
| 特色                                 |           SharedPreferences           |  Preferences<br>DataStore   |     Proto<br>DataStore      |
| ------------------------------------ | :-----------------------------------: | :-------------------------: | :-------------------------: |
| 异步操作                             | √<br>(仅在通过listener读改动过的数据) |       √<br>(通过Flow)       |       √<br>(通过Flow)       |
| 同步操作                             |   √<br>(在UI线程中操作会有安全风险)   |              x              |              x              |
| UI线程使用的<br>安全性               |                   x                   | √<br>(会转到Dispatchers.IO) | √<br>(会转到Dispatchers.IO) |
| 可以发出错误信号<br>Can signal error |                   x                   |              √              |              √              |
| 在运行异常中的安全性                 |                   x                   |              √              |              √              |
| 具有高度一致性保证的事务性API<br>Has a transactional API with strong consistency guarantees        |                   x                   |              √              |              √              |
| 数据迁移                             |                   x                   | √<br>(从SharedPreferences)  | √<br>(从SharedPreferences)  |
| 类型安全性                           |                   x                   |              x              |     √(Protocol Buffers)     |

该表格摘自Codelab。

